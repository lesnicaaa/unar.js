
/**
*   Unar.js v0.0.3
*   (c) 2017-2018 author:like
*   Released under the MIT License.
*/ 

(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global.Unar = factory());
}(this, (function () { 'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/**
 * DomEvent
 */
var DomEvent = function () {
	function DomEvent() {
		_classCallCheck(this, DomEvent);
	}

	_createClass(DomEvent, null, [{
		key: "bind",
		value: function bind(node, prop, val, oldValue) {
			if (val !== oldValue) {
				node[prop] = val;
			}
		}
	}, {
		key: "addEvt",
		value: function addEvt(node, evt, fn) {
			node.addEventListener(evt, fn, false);
		}
	}]);

	return DomEvent;
}();

var propType = {
    switch: undefined
    //console 
};window.propType = propType;

var _createClass$1 = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck$1(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/**
 * one vm prop <---> one Hub
 */

// a:{id: 1, prop: "a", listeners: [cb1,cb2]
// b:{id: 2, prop: "b", listeners: [cb3,cb4]
var hubs = {};

window.hubs = hubs;
var id = 0;

var Hub = function () {
	function Hub(prop, cb, vm) {
		_classCallCheck$1(this, Hub);

		this.id = ++id;
		this.prop = prop;
		console.log("\u2193  get -->" + prop + ",new hub");
		this.val = vm[prop];
		this.vm = vm;
		this.listeners = [];
		this.addListener(cb);
	}

	_createClass$1(Hub, [{
		key: "addListener",
		value: function addListener(cb) {
			this.listeners.push(cb);
		}
	}, {
		key: "deleteListener",
		value: function deleteListener(inx) {
			this.listeners.splice(inx, 1);
		}
	}, {
		key: "notify",
		value: function notify() {
			var _this = this;

			this.listeners.forEach(function (fn) {
				//oldVal->this.val
				//val->this.vm[this.prop]
				fn.call(_this.vm, _this.vm[_this.prop], _this.val);
			});
			//update val to oldVal
			this.val = this.vm[this.prop];
		}
	}]);

	return Hub;
}();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };
var typeOf = function typeOf(o) {
	var _target;
	return ((_target = typeof o === 'undefined' ? 'undefined' : _typeof(o)) == "object" ? Object.prototype.toString.call(o).slice(8, -1) : _target).toLowerCase();
};

// export const run = (exp, scope) => {
// 	try {
// 		with(scope) {
// 			return eval(exp)
// 		}
// 	} catch (e) {
// 		console.error('translate exp abnormal')
// 	}
// }

// a +"b" === ? "sth" :b
// scope.a +"b" === ? "sth" :scope.b
//"a +'b' === ? 'sth' :b".replace(/[\"\']?(\w+)[\"\']?/g,(e)=>{console.log(e);return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e:'scope.'+e})
//'a +"b" === ? "sth" :b'.replace(/[\"\']?(\w+)[\"\']?/g,(e)=>{console.log(e);return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e:'scope.'+e})
// const scopeExp = (exp, vm) =>
// 	exp.replace(/[\"\']?(\w+)[\"\']?/g, (e) =>
// 		e.startsWith('"') && e.endsWith('"') ||
// 		e.startsWith("'") && e.endsWith("'") ? e : (vm + '.' + e)
// 	)

var run = function run(exp, scope) {
	try {
		var fn;
		fn = new Function('vm', 'with(vm){return ' + exp + '}');
		return fn(scope);
	} catch (e) {
		console.error('');
	}
};

var _createClass$2 = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck$2(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }
var count = 0;

var Register = function () {
	function Register() {
		_classCallCheck$2(this, Register);
	}

	_createClass$2(Register, null, [{
		key: "registDomListener4Hubs",
		value: function registDomListener4Hubs(node, prop, key, vm, preTxt, nxtTxt) {
			if (vm.computeds[key]) {
				//count several nodes ->same computed prop
				propType.switch = key + '$' + ++count;
				var ccb = function ccb() {
					DomEvent.bind(node, prop, preTxt + run(key, vm) + nxtTxt);
				};
				propType[key + '$' + count] = ccb;
				ccb();
				propType.switch = undefined;
			} else {
				var cb = function cb(val, oldVal) {
					DomEvent.bind(node, prop, preTxt + val + nxtTxt, preTxt + oldVal + nxtTxt);
				};
				console.log("\u521D\u59CB\u5316\u9875\u9762\uFF0C" + key + "?????" + run(key, vm));
				cb(run(key, vm));
				this.registListener4Hubs(key, cb, vm);
			}
		}
	}, {
		key: "registListener4Hubs",
		value: function registListener4Hubs(key, cb, vm) {
			hubs[key] ? hubs[key].listeners.push(cb) : hubs[key] = new Hub(key, cb, vm);
		}
	}]);

	return Register;
}();

var defaultConfigs = {
    actionPrefix: "u",
    attrPrefix: ":",
    evtPrefix: "@"
};

var _slicedToArray$1 = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();
var config = function config(configs, vm) {
	vm.configs = Object.assign(defaultConfigs, configs);
};
var hijack = function hijack(data, key, vm) {
	Object.defineProperty(vm, key, {
		get: function get() {
			//it can replaced by this._data[key],this.$options.data[key] ,o.data[key]
			//not allow valCache
			//this will call `accessor get fn` 
			return data[key];
		},
		set: function set(newVal) {
			data[key] = newVal;
		}
	});
};
var accessor = function accessor(data, key, vm) {
	//Data properties->data[key]
	//it's cached,data[key] can replaced by vm._data[key],vm.$options.data,o.data 
	var valCache = data[key];
	//Accessor properties
	//data reference->At the same time, vm._data ,vm.$options.data, o.data become three accessor properties
	Object.defineProperty(data, key, {
		get: function get() {
			//vm._data[key],vm.$options.data[key],data[key]
			//maximum call stack size exceeded

			//computeds
			if (propType.switch) {
				var currentComputedType = propType.switch;
				console.log("\u2191  computed->ccb run," + propType.switch + "\u7528\u5230\u4E86" + key + "\uFF0C\u5411" + key + "\u6CE8\u518C" + propType.switch + "\u51FD\u6570");
				var cfn = function cfn() {
					//node fn
					propType[currentComputedType]();
					var ckey = currentComputedType.split('$')[0];
					console.log("----------" + currentComputedType + "," + ckey + "-----------");
					//pure computed fn
					typeOf(vm.computeds[ckey]) === "function" ? vm.computeds[ckey].call(vm) : typeOf(vm.computeds[ckey]) === "object" ? vm.computeds[ckey].get.call(vm) : "";
				};
				Register.registListener4Hubs(key, cfn, vm);
			}
			return valCache;
		},
		set: function set(newVal) {
			valCache = newVal;
			//object 
			// if (typeOf(newVal) === 'object') {
			// 	proxy(newVal, vm)
			// }
			//array
			// if (typeOf(newVal) === 'array') {
			// 	// TODO observe array
			// }
			//set value first,then notify dom update with newVal
			hubs[key].notify();
		}
	});
};
var proxy = function proxy(data, vm) {
	Object.keys(data).forEach(function (key) {
		accessor(data, key, vm);
		hijack(data, key, vm);
	});
};
var watch = function watch(watchers, vm) {
	//Object.entries({a:1})-->[["a", 1]]
	var _iteratorNormalCompletion = true;
	var _didIteratorError = false;
	var _iteratorError = undefined;

	try {
		for (var _iterator = Object.entries(watchers)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
			var _ref = _step.value;

			var _ref2 = _slicedToArray$1(_ref, 2);

			var key = _ref2[0];
			var cb = _ref2[1];

			Register.registListener4Hubs(key, cb, vm);
		}
	} catch (err) {
		_didIteratorError = true;
		_iteratorError = err;
	} finally {
		try {
			if (!_iteratorNormalCompletion && _iterator.return) {
				_iterator.return();
			}
		} finally {
			if (_didIteratorError) {
				throw _iteratorError;
			}
		}
	}
};

var compute = function compute(computeds, vm) {
	/**
  * 	var o={}
 	Object.defineProperty(o, 'a', {
 		get: function () {return 1 },
 		set: function () { }
 	})
 	Object.getOwnPropertyDescriptor(o,'a')
 	{get: ƒ, set: ƒ, enumerable: false, configurable: false}
  */
	var _iteratorNormalCompletion2 = true;
	var _didIteratorError2 = false;
	var _iteratorError2 = undefined;

	try {
		for (var _iterator2 = Object.entries(computeds)[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
			var _ref3 = _step2.value;

			var _ref4 = _slicedToArray$1(_ref3, 2);

			var key = _ref4[0];
			var target = _ref4[1];

			Object.defineProperty(vm, key, {
				configurable: false,
				enumerable: true,
				get: typeOf(target) === "function" ? target : typeOf(target) === "object" ? target.get : function () {},
				set: typeOf(target) === "object" ? target.set : function () {}
			});
		}
	} catch (err) {
		_didIteratorError2 = true;
		_iteratorError2 = err;
	} finally {
		try {
			if (!_iteratorNormalCompletion2 && _iterator2.return) {
				_iterator2.return();
			}
		} finally {
			if (_didIteratorError2) {
				throw _iteratorError2;
			}
		}
	}
};

var _createClass$3 = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck$3(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Attr = function () {
	function Attr() {
		_classCallCheck$3(this, Attr);
	}

	_createClass$3(Attr, null, [{
		key: "isExpression",
		value: function isExpression(txt) {
			return (/\{\{.*\}\}/.test(txt)
			);
		}
	}, {
		key: "expressionKey",
		value: function expressionKey(txt) {
			return txt.match(/(.*)\{\{(.*)\}\}(.*)/);
		}
	}, {
		key: "isRightDetec",
		value: function isRightDetec(detective, configs) {
			var detec;
			for (var prefix in configs) {
				if (detective.startsWith(configs[prefix])) {
					detec = {
						detectype: detective.substring(0, configs[prefix].length),
						detec: detective.substring(configs[prefix].length)
					};
					break;
				}
			}
			return detec;
		}
	}]);

	return Attr;
}();

var _createClass$4 = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck$4(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Detictive = function () {
	function Detictive() {
		_classCallCheck$4(this, Detictive);
	}

	_createClass$4(Detictive, null, [{
		key: "bind",
		value: function bind(node, prop, key, vm) {
			var preTxt = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : '';
			var nxtTxt = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : '';

			// model  html
			// {{}}
			// :id
			Register.registDomListener4Hubs(node, prop, key, vm, preTxt, nxtTxt);
			if (prop === 'value') {
				var fn = function fn(e) {
					return vm[key] = e.target.value;
				};
				this.addEvt(node, 'input', fn, vm);
			}
		}
	}, {
		key: "addEvt",
		value: function addEvt(node, evt, key, vm) {
			//dom ,user input event ,default implement
			//@
			var fn = typeof key === "function" ? key : vm.methods[key].bind(vm);
			DomEvent.addEvt(node, evt, fn);
		}
	}]);

	return Detictive;
}();

var _slicedToArray$2 = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _createClass$5 = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck$5(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Templater = function () {
	function Templater(selector, vm) {
		_classCallCheck$5(this, Templater);

		this.vm = vm;
		this.el = document.querySelector(selector);
		this.el.appendChild(this.init());
	}

	_createClass$5(Templater, [{
		key: "init",
		value: function init() {
			var _this = this;

			var docFrag = document.createDocumentFragment();
			//translat dom to fragment
			this.translate(docFrag).childNodes.forEach(function (node) {
				//init view
				_this.initAttr(node);
			});
			return docFrag;
		}
	}, {
		key: "translate",
		value: function translate(docFrag) {
			for (var i = 0; i < this.el.childNodes.length; i++) {
				var node = this.el.childNodes[i];
				if (this.isValidType(node)) {
					docFrag.appendChild(node);
					--i;
				}
			}
			return docFrag;
		}
	}, {
		key: "initAttr",
		value: function initAttr(node) {
			var _this2 = this;

			var props = {
				model: 'value', //v-model
				html: 'innerHTML', //v-html
				text: 'textContent', //{{}}
				class: 'className' //:class
			};
			if (node.nodeType === 1) {
				//for (let attr of node.attributes) {
				new Array().slice.call(node.attributes).forEach(function (attr) {
					var detective = attr.nodeName;
					var key = attr.nodeValue;
					var detecInfo = Attr.isRightDetec(detective, _this2.vm.configs);

					var _ref = detecInfo ? detecInfo : {
						detectype: undefined,
						detec: undefined
					},
					    detectype = _ref.detectype,
					    detec = _ref.detec;

					if (detec) {
						node.removeAttribute(detective);
						var prop = props[detec] ? props[detec] : detec;
						if (detectype === _this2.vm.configs.evtPrefix) {
							//@click
							Detictive.addEvt(node, prop, key, _this2.vm);
						} else {
							//u-html u-model
							//:id
							Detictive.bind(node, prop, key, _this2.vm);
						}
					}
				});
				node.childNodes.forEach(function (childNode) {
					_this2.initAttr(childNode);
				});
				return;
			}
			if (node.nodeType === 3) {
				if (Attr.isExpression(node.data)) {
					//text with {{}}
					var _Attr$expressionKey = Attr.expressionKey(node.data),
					    _Attr$expressionKey2 = _slicedToArray$2(_Attr$expressionKey, 4),
					    preTxt = _Attr$expressionKey2[1],
					    key = _Attr$expressionKey2[2],
					    nxtTxt = _Attr$expressionKey2[3];

					Detictive.bind(node, props.text, key, this.vm, preTxt, nxtTxt);
				}
			}
		}
	}, {
		key: "isValidType",
		value: function isValidType(node) {
			//for reduce the loop count ,filter nodes to Element Comment Text(not contain pure whitespace)
			return node.nodeType === 1 || node.nodeType === 8 || node.nodeType === 3 && !this.isPureBlankNode(node);
		}
		//https://developer.mozilla.org/zh-CN/docs/Web/Guide/API/DOM/Whitespace_in_the_DOM

	}, {
		key: "isPureBlankNode",
		value: function isPureBlankNode(node) {
			// Use ECMA-262 Edition 3 String and RegExp features
			return !/[^\t\n\r ]/.test(node.data);
		}
	}]);

	return Templater;
}();

function _classCallCheck$6(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Unar =
// static hubs = []
function Unar(_ref) {
		var _ref$el = _ref.el,
		    el = _ref$el === undefined ? '' : _ref$el,
		    _ref$data = _ref.data,
		    data = _ref$data === undefined ? {} : _ref$data,
		    _ref$computeds = _ref.computeds,
		    computeds = _ref$computeds === undefined ? {} : _ref$computeds,
		    _ref$methods = _ref.methods,
		    methods = _ref$methods === undefined ? {} : _ref$methods,
		    _ref$watchers = _ref.watchers,
		    watchers = _ref$watchers === undefined ? {} : _ref$watchers,
		    configs = _ref.configs;

		_classCallCheck$6(this, Unar);

		this.methods = methods;

		//we can config the dom detective about actions props event
		config(configs, this);

		//this.$options = {}
		//this add keys(_data、$options )
		//var data = this._data = this.$options.data = data

		//hijack properties
		//change data properties to accessor properties
		proxy(data, this);

		//add computed properties to this
		this.computeds = computeds;
		compute(this.computeds, this);

		//console.log(this)
		//add watchers properties to this
		this.watchers = watchers;
		watch(this.watchers, this);

		// if the template does not define the properties of the data,
		// it will not subscribe to the hubs inside the event

		//compile fragment
		new Templater(el, this);
}
// $watch() {}
// static use() {}
// static extend() {}
// static $nextTick() {}
// $get() {
//     //utils.get(this, key, val)
// }
// $set() {
//     utils.set(this, key, val)
// }
// $created() {}
// $mounted() {}
// $computed() {}
// $remove() {}
// $destroy() {}
// $before() {}
// $after() {}
// 'emit', 'on', 'off', 'once'
;

return Unar;

})));
